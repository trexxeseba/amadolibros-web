<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Amado Libros</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111111;
      --muted: #5b5b5b;
      --border: #e8e8ee;
      --shadow: 0 10px 30px rgba(0,0,0,.08);

      /* Mercado Libre */
      --ml-yellow: #FFE600;
      --ml-blue: #2D3277;

      /* WhatsApp (más oscuro) */
      --wa: #128C7E;
      --wa-hover: #0f756a;

      /* Neutral */
      --neutral: #f3f4f6;
      --neutral-border: #d8dbe2;
      --neutral-text: #111;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 16px 48px;
    }

    header{
      padding: 18px 16px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex;
      gap: 14px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .brand img{
      width: 56px;
      height: 56px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 6px;
    }

    h1{
      font-family: "Playfair Display", serif;
      font-size: 38px;
      margin:0;
      line-height: 1.05;
    }

    .subtitle{
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .desc{
      margin: 10px 0 0;
      color: #2a2a2a;
      font-size: 14px;
      line-height: 1.55;
      max-width: 880px;
    }

    .top-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: center;
      margin-top: 14px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      text-decoration:none;
      font-weight: 600;
      font-size: 14px;
      cursor:pointer;
      transition: transform .08s ease, opacity .15s ease, background .15s ease, border-color .15s ease;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .btn-ml{
      background: var(--ml-yellow);
      border-color: var(--ml-yellow);
      color: var(--ml-blue);
    }
    .btn-ml:hover{ opacity: .92; }

    .btn-wa{
      background: var(--wa);
      border-color: var(--wa);
      color: #fff;
    }
    .btn-wa:hover{ background: var(--wa-hover); border-color: var(--wa-hover); }

    .btn-neutral{
      background: var(--neutral);
      border-color: var(--neutral-border);
      color: var(--neutral-text);
    }
    .btn-neutral:hover{ opacity: .92; }

    .searchbar{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .searchbar input{
      width: min(520px, 100%);
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      outline: none;
    }

    .meta{
      color: var(--muted);
      font-size: 13px;
      margin-top: 8px;
    }

    /* Promo bar (urgente, minimalista) */
    .promo-bar{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .promo-bar strong{ font-weight: 800; }
    .promo-link{
      color: var(--ml-blue);
      text-decoration: none;
      font-weight: 800;
      white-space: nowrap;
    }
    .promo-link:hover{ text-decoration: underline; }
    .promo-foot{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    main{ margin-top: 18px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 820px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-height: 100%;
    }

    /* Imagen pro: no recorta */
    .thumb{
      width: 100%;
      aspect-ratio: 3 / 4;
      background: #fff;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px;
    }
    .thumb img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    .content{
      padding: 12px 12px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    .title{
      font-weight: 700;
      font-size: 15px;
      line-height: 1.25;
      margin: 0;
      color: var(--text);

      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: calc(15px * 1.25 * 2.6);
    }

    .price{
      font-weight: 800;
      font-size: 14px;
      margin: 0;
      color: #111;
    }

    .actions{
      margin-top: auto;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions .btn{
      flex: 1 1 160px;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
    }

    .loadmore{
      margin: 18px auto 0;
      display:flex;
      justify-content:center;
    }

    .footer-note{
      margin-top: 16px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="logo.jpeg" alt="Amado Libros"
             onerror="this.onerror=null; this.src='logo.png';"/>
        <div>
          <h1>Amado Libros</h1>
          <div class="subtitle">Catálogo curado · Libros importados · Pedidos especiales</div>
        </div>
      </div>

      <div class="desc">
        Traemos libros, música, antigüedades y objetos seleccionados del exterior. Libros por encargo, ediciones agotadas y piezas para coleccionistas.
      </div>

      <div class="top-actions">
        <a class="btn btn-ml" target="_blank" rel="noopener"
           href="https://www.mercadolibre.com.uy/tienda/amado-libros-libreria-en-linea#from=share_eshop">
          Ver tienda en Mercado Libre
        </a>

        <a class="btn btn-wa" target="_blank" rel="noopener"
           href="https://wa.me/59899841325?text=Hola%20Amado%20Libros%2C%20quiero%20consultar%20por%20un%20libro.%20">
          WhatsApp (comprar / consultar)
        </a>
      </div>

      <div class="promo-bar">
        <div>
          <strong>Pagos hasta 12 cuotas</strong> · Envíos Montevideo <strong>menos de 2 horas</strong>
        </div>
        <a class="promo-link" target="_blank" rel="noopener"
           href="https://www.mercadolibre.com.uy/tienda/amado-libros-libreria-en-linea#from=share_eshop">
          Link de pago (Mercado Libre)
        </a>
      </div>
      <div class="promo-foot">
        *Envíos rápidos sujetos a zona y horario de compra (Flex).
      </div>

      <div class="searchbar">
        <input id="q" type="search" placeholder="Buscar por título… (ej: Biblia, Yalom, Battle Royale)" />
      </div>

      <div class="meta" id="meta">Cargando catálogo…</div>
    </header>

    <main>
      <div class="grid" id="grid"></div>

      <div class="loadmore" id="loadMoreWrap" style="display:none;">
        <button class="btn btn-neutral" id="loadMoreBtn" type="button">Cargar más</button>
      </div>

      <div class="footer-note">
        Por WhatsApp podés comprar, consultar y coordinar. Estamos encantados de servirte.
      </div>
    </main>
  </div>

  <script>
    const JSON_URL = "./catalogo_amado_libros.json";
    const WA_PHONE = "59899841325";
    const STORE_URL = "https://www.mercadolibre.com.uy/tienda/amado-libros-libreria-en-linea#from=share_eshop";

    const grid = document.getElementById("grid");
    const meta = document.getElementById("meta");
    const q = document.getElementById("q");

    const loadMoreWrap = document.getElementById("loadMoreWrap");
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    let items = [];
    let filtered = [];
    let shown = 0;
    const PAGE_SIZE = 24;

    function moneyUYU(value){
      try{
        return new Intl.NumberFormat("es-UY", { style:"currency", currency:"UYU", maximumFractionDigits:0 }).format(value || 0);
      }catch(e){
        return "$U " + (value || 0);
      }
    }

    function normalizeHttps(url){
      return (url || "").replace(/^http:\/\//i, "https://");
    }

    // Mejora: ML -I -> -O (si existe). Si no existe, fallback via onerror al original
    function upgradeMlImage(url){
      if(!url) return url;
      let u = normalizeHttps(url);
      u = u.replace(/-I(\.(jpg|jpeg|png|webp))$/i, "-O$1");
      return u;
    }

    // DISPONIBLE = active y (si hay qty numérico) qty > 0
    function isAvailable(item){
      const status = String(item.status || "").toLowerCase();
      const qty = item.available_quantity;
      const qtyOk = (typeof qty !== "number") ? true : qty > 0;
      return status === "active" && qtyOk;
    }

    function waLink(text){
      return `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(text)}`;
    }

    function buildCard(item){
      const card = document.createElement("div");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.decoding = "async";
      img.alt = item.title || "Producto";

      const originalThumb = normalizeHttps(item.thumbnail || "");
      const upgradedThumb = upgradeMlImage(originalThumb);

      img.src = upgradedThumb;
      img.onerror = () => {
        if(img.src !== originalThumb){
          img.src = originalThumb;
        }
      };

      thumb.appendChild(img);

      const content = document.createElement("div");
      content.className = "content";

      const title = document.createElement("p");
      title.className = "title";
      title.textContent = item.title || "Sin título";

      const price = document.createElement("p");
      price.className = "price";
      price.textContent = moneyUYU(item.price);

      const actions = document.createElement("div");
      actions.className = "actions";

      const aML = document.createElement("a");
      aML.className = "btn btn-ml";
      aML.target = "_blank";
      aML.rel = "noopener";
      aML.href = item.permalink || STORE_URL;
      aML.textContent = "Comprar en Mercado Libre";

      const aWA = document.createElement("a");
      aWA.className = "btn btn-wa";
      aWA.target = "_blank";
      aWA.rel = "noopener";
      aWA.href = waLink(`Hola Amado Libros, quiero comprar/consultar por: ${item.title}. Link: ${item.permalink || STORE_URL}`);
      aWA.textContent = "Comprar por WhatsApp";

      actions.appendChild(aML);
      actions.appendChild(aWA);

      content.appendChild(title);
      content.appendChild(price);
      content.appendChild(actions);

      card.appendChild(thumb);
      card.appendChild(content);

      return card;
    }

    function renderNext(){
      const end = Math.min(shown + PAGE_SIZE, filtered.length);
      for(let i = shown; i < end; i++){
        grid.appendChild(buildCard(filtered[i]));
      }
      shown = end;

      loadMoreWrap.style.display = (shown < filtered.length) ? "flex" : "none";
      meta.textContent = `${filtered.length} productos disponibles. Mostrando ${shown}.`;
    }

    loadMoreBtn.addEventListener("click", renderNext);

    function applySearch(){
      const term = (q.value || "").trim().toLowerCase();
      filtered = term
        ? items.filter(it => (it.title || "").toLowerCase().includes(term))
        : items;

      grid.innerHTML = "";
      shown = 0;

      if(filtered.length === 0){
        meta.textContent = "Sin resultados para esa búsqueda.";
        loadMoreWrap.style.display = "none";
        return;
      }

      renderNext();
    }

    async function init(){
      try{
        const res = await fetch(JSON_URL, { cache: "no-store" });
        if(!res.ok) throw new Error("No se pudo cargar el JSON");
        const data = await res.json();

        let raw = Array.isArray(data) ? data : (data.items || []);
        if(!Array.isArray(raw)) raw = [];

        // Normalizamos
        raw = raw.map(x => ({
          id: x.id,
          title: x.title,
          price: x.price,
          currency: x.currency,
          permalink: x.permalink,
          thumbnail: x.thumbnail,
          available_quantity: x.available_quantity,
          status: x.status
        }));

        // FILTRO CLAVE: ocultamos pausados/cerrados/sin stock para evitar redirecciones
        const total = raw.length;
        items = raw.filter(isAvailable);
        const hidden = total - items.length;

        // Orden alfabético
        items.sort((a,b)=> String(a.title||"").localeCompare(String(b.title||""), "es", { sensitivity:"base" }));

        meta.textContent = `${items.length} productos disponibles. Ocultos (pausados/sin stock): ${hidden}.`;
        applySearch();
      }catch(err){
        meta.textContent = "Error cargando el catálogo. Revisá que exista catalogo_amado_libros.json en la raíz del repo.";
        console.error(err);
      }
    }

    q.addEventListener("input", ()=>{
      window.clearTimeout(window.__t);
      window.__t = window.setTimeout(applySearch, 120);
    });

    init();
  </script>
</body>
</html>
